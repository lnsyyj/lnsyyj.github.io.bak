---
title: 文件系统
date: 2019-03-24 13:36:08
tags: 存储
---

资料来自[学堂在线](http://www.xuetangx.com/)，课程：30240243X 操作系统（自主模式）

# 第二十一讲 文件系统

## 21.1 文件系统和文件

### 文件系统的概念 —— 文件系统和文件

什么是文件系统？

文件系统是操作系统中管理持久性数据的子系统，提供数据存储和访问功能。

- 组织、检索、读写访问数据
- 大多数计算机系统都有文件系统
- Google也是一个文件系统



什么是文件？

文件是具有符号名，由字节序列构成的数据项集合。

- 文件系统的基本数据单位
- 文件名是文件的标识符号



文件系统的功能？

分配文件磁盘空间

- 管理文件块（位置和顺序）
- 管理空闲空间（位置）
- 分配算法（策略）

管理文件集合

- 定位：文件及其内容
- 命名：通过名字找到文件
- 文件系统结构：文件组织方式

数据可靠和安全

- 安全：多层次保护数据安全

- 可靠：持久保存文件。避免系统崩溃、媒体错误、攻击等



文件？

文件属性

- 名称、类型、位置、大小、保护、创建者、创建时间、最近修改时间、...

文件头：文件系统元数据中的文件信息（文件头是存在文件系统元数据当中的文件信息），有了这些文件头的信息之后，我们就能知道要读写的文件数据到底在哪。

- 文件属性
- 文件存储位置和顺序

### 文件系统的概念 —— 文件描述符

什么是文件描述符？

文件描述符是指打开的文件，它在内存当中所维护的相关信息。



文件访问模式

- 进程访问文件数据前必须先“打开”文件

```
fd = open(name, flag);
...
read(fd, ...);
...
close(fd);
```

内核跟踪进程打开的所有文件

- 操作系统为每个进程维护一个打开文件表（文件表里每一项对应一个打开的文件，这时候给它一个标识，就是文件描述符）
- 文件描述符是打开文件的标识



文件描述符是操作系统在打开文件表中维护的打开文件的状态和信息

- 文件指针（最近一次读写位置，每个进程分别维护自己的打开文件指针）
- 文件打开计数（当前打开文件的次数、最后一个进程关闭文件时，将其从打开文件表中移除）
- 文件的磁盘位置（缓存数据访问信息）
- 访问权限（每个进程的文件访问模式信息）



文件用户视图

- 持久的数据结构

系统访问接口

- 字节序列的集合（UNIX）
- 系统不关心存储在磁盘上的数据结构

操作系统的文件视图

- 数据块的集合
- 数据块是逻辑存储单元，而扇区是物理存储单元
- 块大小<>扇区大小（几个扇区构成一个数据块）

进程读文件

- 获取字节所在的数据块（整块读出来，读一个字节也必须把整块读出来，写一个字节也必须整块写）
- 返回数据块内对应部分

进程写文件

- 获取数据块
- 修改数据块中对应部分
- 写回数据块（整块写）

文件系统中的基本操作单位是数据块

- 例如，getc()和putc()即使每次只访问1字节的数据，也需要缓存目标数据4096字节（读写数据的时候我们一种优化方式是，一块的内容是否有可能把它充分的利用起来）



### 文件系统的概念 —— 访问模式

操作系统需要了解进程如何访问文件？

顺序访问：按字节依次读取

- 大多数的文件访问都是顺序访问

随机访问：从中间读写

- 不常用，但依然重要（例如，虚拟内存中把内存页存储在文件）

索引访问：依据数据特征索引

- 通常操作系统不完整提供索引访问
- 数据库是建立在索引内容的磁盘访问上

### 文件系统的概念 —— 文件内部结构

无结构

- 单词、字节序列

简单记录结构

- 分列
- 固定长度
- 可变长度

复杂结构

- 格式化的文档（如，MS Word，PDF）
- 可执行文件
- ......

### 文件共享和访问控制 —— 文件共享和访问控制

多用户系统中的文件共享是很必要的

访问控制

- 每个用户能够获得哪些文件的哪些访问权限
- 访问模式：读、写、执行、删除、列表等

文件访问控制列表（ACL）

- <文件实体， 权限>

Unix模式

- <用户|组|所有人，读|写|可执行>
- 用户标识ID（识别用户，表明每个用户所允许的权限及保护模式）

### 文件共享和访问控制 —— 语义一致性

规定多进程如何同时访问共享文件

- 与同步算法相似
- 因磁盘I/O和网络延迟而设计简单

Unix文件系统（UFS）语义

- 对打开文件的写入内容立即对其他打开同一文件的其他用户可见
- 共享文件指针允许多用户同时读取和写入文件

会话语义

- 写入内容只有当文件关闭时可见

读写锁

- 一些操作系统和文件系统提供该功能





### 虚拟文件系统



### 文件缓存和打开文件



### 文件分配



### 空闲空间管理



### 冗余磁盘阵列RAID



